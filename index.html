<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>WebGIS RTLH & BSPS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="style.css"/>
</head>
<body>

<div class="topbar">
  <select id="tahun">
    <option value="2021">2021</option>
    <option value="2022">2022</option>
    <option value="2024">2024</option>
    <option value="2025" selected>2025</option>
  </select>

  <select id="jenis">
    <option value="RTLH">RTLH</option>
    <option value="BSPS">BSPS</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([-7.4,111.4],11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let dataGeojson;
let layerDesa;
let layerKecamatan;

// ================= LOAD DATA =================
fetch("DATA BSPS DAN RTLH.geojson")
.then(res=>res.json())
.then(data=>{
  dataGeojson = data;
  updatePeta();
});

// ================= AGREGASI KECAMATAN =================
function agregasiKecamatan(field){

  let hasil = {};

  dataGeojson.features.forEach(f=>{
    let kec = f.properties.KECAMATAN;
    let jumlah = f.properties[field] || 0;

    if(!hasil[kec]){
      hasil[kec] = {
        total:0,
        coords:[]
      };
    }

    hasil[kec].total += jumlah;

    let center = L.geoJSON(f).getBounds().getCenter();
    hasil[kec].coords.push(center);
  });

  return hasil;
}

// ================= TITIK DESA =================
function buatLayerDesa(field, warna){

  return L.geoJSON(dataGeojson,{
    onEachFeature:function(feature,layer){

      let jumlah = feature.properties[field] || 0;
      let center = layer.getBounds().getCenter();

      L.circleMarker(center,{
        radius: Math.sqrt(jumlah)*2,
        fillColor: warna,
        color:"#fff",
        weight:1,
        fillOpacity:0.9
      })
      .bindTooltip(jumlah.toString(),{permanent:true, direction:"center"})
      .addTo(map);

    }
  });
}

// ================= TITIK KECAMATAN =================
function buatLayerKecamatan(field, warna){

  let dataKec = agregasiKecamatan(field);

  let group = L.layerGroup();

  for(let kec in dataKec){

    let item = dataKec[kec];

    // cari titik tengah kecamatan
    let lat = item.coords.reduce((a,b)=>a+b.lat,0)/item.coords.length;
    let lng = item.coords.reduce((a,b)=>a+b.lng,0)/item.coords.length;

    let marker = L.circleMarker([lat,lng],{
      radius: Math.sqrt(item.total)*2,
      fillColor: warna,
      color:"#fff",
      weight:1,
      fillOpacity:0.9
    })
    .bindTooltip(kec+"<br>"+item.total,{permanent:true, direction:"center"});

    group.addLayer(marker);
  }

  return group;
}

// ================= UPDATE =================
function updatePeta(){

  let tahun = document.getElementById("tahun").value;
  let jenis = document.getElementById("jenis").value;

  let field = jenis+" "+tahun;
  let warna = jenis === "RTLH" ? "green" : "blue";

  if(layerDesa) map.removeLayer(layerDesa);
  if(layerKecamatan) map.removeLayer(layerKecamatan);

  if(map.getZoom() >= 13){
    layerDesa = buatLayerDesa(field,warna);
    map.addLayer(layerDesa);
  }else{
    layerKecamatan = buatLayerKecamatan(field,warna);
    map.addLayer(layerKecamatan);
  }
}

// ================= EVENT =================
map.on("zoomend",updatePeta);
document.getElementById("tahun").addEventListener("change",updatePeta);
document.getElementById("jenis").addEventListener("change",updatePeta);
</script>

</body>
</html>
