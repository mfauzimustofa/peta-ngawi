<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <title>WebGIS RTLH & BSPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

<div class="topbar">
  <select id="tahun">
    <option value="2021">2021</option>
    <option value="2022">2022</option>
    <option value="2024">2024</option>
    <option value="2025" selected>2025</option>
  </select>

  <select id="jenis">
    <option value="RTLH">RTLH</option>
    <option value="BSPS">BSPS</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([-7.4,111.4],11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

let geojsonLayer;
let titikLayer;
let dataGeojson;

// ================= WARNA CHOROPLETH =================
function getColor(d){
  return d > 50 ? '#084594' :
         d > 30 ? '#2171b5' :
         d > 20 ? '#4292c6' :
         d > 10 ? '#6baed6' :
         d > 0  ? '#9ecae1' :
                  '#f1f1f1';
}

// STYLE POLYGON
function style(feature, field){
  let value = feature.properties[field] || 0;

  return {
    fillColor: getColor(value),
    weight: 1,
    color: "#444",
    fillOpacity: 0.7
  };
}

// UKURAN TITIK
function getRadius(jumlah){
  return jumlah ? Math.sqrt(jumlah) * 2 : 4;
}

// LOAD DATA
fetch("DATA BSPS DAN RTLH.geojson")
.then(res=>res.json())
.then(data=>{
  dataGeojson = data;
  updatePeta();
});

function updatePeta(){

  let tahun = document.getElementById("tahun").value;
  let jenis = document.getElementById("jenis").value;

  let field = jenis + " " + tahun;

  if(geojsonLayer) map.removeLayer(geojsonLayer);
  if(titikLayer) map.removeLayer(titikLayer);

  // ================= POLYGON =================
  geojsonLayer = L.geoJSON(dataGeojson,{
    style: function(feature){
      return style(feature, field);
    },

    onEachFeature:function(feature,layer){
      layer.bindPopup(
        "<b>Desa:</b> "+feature.properties.DESA+
        "<br><b>Kecamatan:</b> "+feature.properties.KECAMATAN+
        "<hr>"+
        jenis+" "+tahun+" : "+(feature.properties[field] || 0)
      );
    }
  }).addTo(map);

  map.fitBounds(geojsonLayer.getBounds());

  // ================= TITIK TENGAH =================
  titikLayer = L.geoJSON(dataGeojson,{
    pointToLayer:function(feature,latlng){},

    onEachFeature:function(feature,layer){
      let jumlah = feature.properties[field] || 0;

      let center = layer.getBounds().getCenter();

      L.circleMarker(center,{
        radius:getRadius(jumlah),
        fillColor: jenis === "RTLH" ? "green" : "blue",
        color:"#fff",
        weight:1,
        fillOpacity:0.9
      })
      .bindTooltip(jumlah.toString(),{permanent:true, direction:"center"})
      .addTo(map);
    }
  });
}

// FILTER
document.getElementById("tahun").addEventListener("change",updatePeta);
document.getElementById("jenis").addEventListener("change",updatePeta);

</script>

</body>
</html>
