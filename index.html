<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>WebGIS RTLH & BSPS Ngawi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="style.css"/>
</head>
<body>

<div class="topbar">
  <select id="tahun">
    <option value="2021">2021</option>
    <option value="2022">2022</option>
    <option value="2024">2024</option>
    <option value="2025" selected>2025</option>
  </select>

  <select id="jenis">
    <option value="RTLH">RTLH</option>
    <option value="BSPS">BSPS</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([-7.4,111.4],11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let dataGeojson;
let batasLayer;
let titikLayer;

function isMobile(){
  return window.innerWidth <= 768;
}

function getColor(d){
  return d > 50 ? '#084594' :
         d > 30 ? '#2171b5' :
         d > 20 ? '#4292c6' :
         d > 10 ? '#6baed6' :
         d > 0  ? '#9ecae1' :
                  '#f1f1f1';
}

function styleBatas(feature){
  let tahun = document.getElementById("tahun").value;
  let jenis = document.getElementById("jenis").value;
  let field = jenis+" "+tahun;
  let value = feature.properties[field] || 0;

  return {
    fillColor:getColor(value),
    weight:1,
    color:"#444",
    fillOpacity:0.7
  };
}

fetch("DATA BSPS DAN RTLH.geojson")
.then(res=>res.json())
.then(data=>{
  dataGeojson = data;

  batasLayer = L.geoJSON(dataGeojson,{
    style:styleBatas,
    onEachFeature:onEachFeature
  }).addTo(map);

  map.fitBounds(batasLayer.getBounds());
  updateTitik();
});

function onEachFeature(feature,layer){

  layer.on("click", function(){

    let tahun = document.getElementById("tahun").value;

    let rtlh = feature.properties["RTLH "+tahun] || 0;
    let bsps = feature.properties["BSPS "+tahun] || 0;

    batasLayer.resetStyle();

    layer.setStyle({
      weight:2,
      color:"#000",
      fillOpacity:0.9
    });

    layer.bindPopup(
      "<b>Desa :</b> "+feature.properties.DESA+
      "<br><b>Kecamatan :</b> "+feature.properties.KECAMATAN+
      "<hr>"+
      "<b>RTLH "+tahun+" :</b> "+rtlh+
      "<br><b>BSPS "+tahun+" :</b> "+bsps
    ).openPopup();

  });
}

function getRadius(jumlah){
  let r = Math.sqrt(jumlah) * 2;
  return isMobile() ? r * 0.7 : r;
}

function agregasiKecamatan(field){

  let hasil={};

  dataGeojson.features.forEach(f=>{
    let kec = f.properties.KECAMATAN;
    let jumlah = f.properties[field] || 0;

    if(!hasil[kec]){
      hasil[kec]={total:0, coords:[]};
    }

    hasil[kec].total += jumlah;

    let center = L.geoJSON(f).getBounds().getCenter();
    hasil[kec].coords.push(center);
  });

  return hasil;
}

function updateTitik(){

  let tahun = document.getElementById("tahun").value;
  let jenis = document.getElementById("jenis").value;
  let field = jenis+" "+tahun;
  let warna = jenis === "RTLH" ? "green" : "blue";

  if(titikLayer) map.removeLayer(titikLayer);

  titikLayer = L.layerGroup();

  let zoomBatas = isMobile() ? 14 : 13;

  if(map.getZoom() < zoomBatas){

    let dataKec = agregasiKecamatan(field);

    for(let kec in dataKec){

      let item = dataKec[kec];

      let lat = item.coords.reduce((a,b)=>a+b.lat,0)/item.coords.length;
      let lng = item.coords.reduce((a,b)=>a+b.lng,0)/item.coords.length;

      let marker = L.circleMarker([lat,lng],{
        radius:getRadius(item.total),
        fillColor:warna,
        color:"#fff",
        weight:1,
        fillOpacity:0.9
      });

      if(!isMobile()){
        marker.bindTooltip(kec+"<br>"+item.total,{permanent:true});
      }

      titikLayer.addLayer(marker);
    }

  } else {

    dataGeojson.features.forEach(f=>{

      let jumlah = f.properties[field] || 0;
      let center = L.geoJSON(f).getBounds().getCenter();

      let marker = L.circleMarker(center,{
        radius:getRadius(jumlah),
        fillColor:warna,
        color:"#fff",
        weight:1,
        fillOpacity:0.9
      });

      if(map.getZoom() >= (isMobile()?15:13)){
        marker.bindTooltip(jumlah.toString(),{
          permanent:true,
          direction:"center"
        });
      }

      titikLayer.addLayer(marker);

    });
  }

  titikLayer.addTo(map);
  batasLayer.setStyle(styleBatas);
}

map.on("zoomend",updateTitik);
document.getElementById("tahun").addEventListener("change",updateTitik);
document.getElementById("jenis").addEventListener("change",updateTitik);
</script>

</body>
</html>
